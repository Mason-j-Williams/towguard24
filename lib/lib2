aiClient.ts
// lib/aiClient.ts
export type AIMessage = {
  role: "system" | "user" | "assistant";
  content: string;
};

export type AIResponse = {
  content: string;
};

const AI_API_KEY = process.env.GEMINI_API_KEY;

if (!AI_API_KEY) {
  console.warn("Missing GEMINI_API_KEY environment variable.");
}

export async function callAI(messages: AIMessage[]): Promise<AIResponse> {
  if (!AI_API_KEY) {
    throw new Error("GEMINI_API_KEY is not set.");
  }

  // Combine messages into one text block for Gemini
  const text = messages
    .map((m) => `${m.role.toUpperCase()}: ${m.content}`)
    .join("\n\n");

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${AI_API_KEY}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          {
            role: "user",
            parts: [{ text }],
          },
        ],
      }),
    }
  );

  if (!res.ok) {
    const text = await res.text();
    console.error("Gemini error:", text);
    throw new Error(`Gemini request failed: ${res.status} ${text}`);
  }

  const data = await res.json();

  const content =
    data.candidates?.[0]?.content?.parts?.[0]?.text ??
    JSON.stringify(data);

  return { content };
}

